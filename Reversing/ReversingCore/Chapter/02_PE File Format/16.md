## Base Relocation Table

PE파일의 재배치 과정에 사용되는 Base Relocation Table 구조와 동작원리에 대해 알아보자.

### PE 재배치
PE 파일(EXE, DLL, SYS)이 프로세스 가상메모리에 로딩될 때 **PE 헤더의 ImageBase 주소에 로딩**된다. DLL(SYS) 파일의 경우 **ImageBase 위치에 이미 다른 DLL파일이 로딩돼 있다면 다른 비어있는 주소 공간에 로딩**되며, 이것을 **PE 재배치**라고 한다. 

<span style="color:gray">

> *SDK*(*Software Development Kit*) *또는 Visual C++로 PE파일을 생성하면 기본적으로 EXE의 경우 ImageBase=00400000, DLL의 경우 ImageBase=10000000으로 설정된다. 또한 DDK(Driver Development Kit)로 생성된 SYS파일은 기본적으로 ImageBase=100000으로 설정된다.* 

</span>

1. **DLL/SYS** <br>
TEST.exe 프로세스에 A.dll이 10000000 주소에 로딩되어 있다고 하자. 이후 B.dll이 같은 주소(10000000)에 로딩을 시도하면 PE로더는 비어있는 다른 주소(3ㅊ000000)에 B.dll을 로딩시킨다.

2. **EXE** <br>
프로세스가 생성될 때 exe파일이 가장 먼저 메모리에 로딩되기 때문에 exe에서는 재배치를 고려할 필요가 없었지만 Windows Vista이후부터 보안강화를 위해 **ASLR**(**Address Space Layout Randonmizition**)기능이 추가되었다. 이것을 **exe 파일이 실행될 때마다 랜덤한 주소에 로딩되게 한다.**

